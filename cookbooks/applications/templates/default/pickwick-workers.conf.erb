check process <%= node.applications[:workers][:name] %>-puma with pidfile <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>.pid
  start program = "/bin/su - <%= node.applications[:user] %> -c 'cd <%= node.applications[:dir] %>/<%= node.applications[:workers][:name] %> && RUBY_GC_MALLOC_LIMIT=<%= node.applications[:ruby_gc_malloc_limit] %> SIDEKIQ_REDIS_URL=redis://<%= node.applications[:workers][:sidekiq][:ip] %>:6379 SIDEKIQ_USERNAME=<%= node.applications[:workers][:sidekiq][:username] %> SIDEKIQ_PASSWORD=<%= node.applications[:workers][:sidekiq][:password] %> PICKWICK_API_URL=<%= node.applications[:workers][:api][:url] %> PICKWICK_API_TOKEN=<%= node.applications[:workers][:api][:token] %> bundle exec puma -e <%= node.applications[:workers][:environment] %> --bind unix://<%= node.applications[:workers][:puma][:directories][:sockets] %>/<%= node.applications[:workers][:name] %>.sock --pidfile <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>.pid --threads <%= node.applications[:workers][:puma][:threads][:min] %>:<%= node.applications[:workers][:puma][:threads][:max] %> --workers 1 --daemon'" with timeout <%= node.applications[:workers][:puma][:wait] %> seconds
  stop program = "/bin/su - <%= node.applications[:user] %> -c 'kill -9 `cat <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>.pid` && rm <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>.pid'"

  if totalmem > 95% for 15 cycles then restart

  group <%= node.applications[:workers][:name] %>_puma

check process <%= node.applications[:workers][:name] %>-sidekiq with pidfile <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>_sidekiq.pid
  start program = "/bin/su - <%= node.applications[:user] %> -c 'cd <%= node.applications[:dir] %>/<%= node.applications[:workers][:name] %> && RUBY_GC_MALLOC_LIMIT=<%= node.applications[:ruby_gc_malloc_limit] %> SIDEKIQ_REDIS_URL=redis://<%= node.applications[:workers][:sidekiq][:ip] %>:6379 PICKWICK_API_URL=<%= node.applications[:workers][:api][:url] %> PICKWICK_API_TOKEN=<%= node.applications[:workers][:api][:token] %> bundle exec sidekiq --config config/sidekiq_queues.yml -e <%= node.applications[:workers][:environment] %> --pidfile <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>_sidekiq.pid --logfile <%= node.applications[:dir] %>/<%= node.applications[:workers][:name] %>/log/sidekiq.log --daemon'"
  stop program = "/bin/su - <%= node.applications[:user] %> -c 'kill -9 `cat <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>_sidekiq.pid` && rm <%= node.applications[:workers][:puma][:directories][:pids] %>/<%= node.applications[:workers][:name] %>_sidekiq.pid'"

  if totalmem > 95% for 15 cycles then restart

  group <%= node.applications[:workers][:name] %>_sidekiq
